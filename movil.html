<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOULIN M√ìVIL V70</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCAsCocDQjimpjNo5l2oHTGO82XNTG7tzY",
            authDomain: "transporte-moulin.firebaseapp.com",
            databaseURL: "https://transporte-moulin-default-rtdb.firebaseio.com",
            projectId: "transporte-moulin",
            storageBucket: "transporte-moulin.firebasestorage.app",
            messagingSenderId: "1022730425566",
            appId: "1:1022730425566:web:1ec5b014b71d14ce579e4f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        const sesion = JSON.parse(sessionStorage.getItem('moulin_sesion'));
        if (!sesion) { window.location.href = "index.html"; }

        window.historial = [];

        onValue(ref(db, 'moulin/guias'), (snapshot) => {
            const data = snapshot.val();
            window.historial = data ? Object.entries(data).map(([id, val]) => ({...val, firebaseID: id})).reverse() : [];
            renderizarLista();
        });

        window.actualizarEstado = (id, nuevoEstado) => {
            update(ref(db, `moulin/guias/${id}`), { estado: nuevoEstado });
            alert("Estado actualizado!");
        };

        window.renderizarLista = () => {
            const busq = document.getElementById('search').value.toLowerCase();
            const filtrados = window.historial.filter(g => 
                g.num.toLowerCase().includes(busq) || 
                (g.d_n && g.d_n.toLowerCase().includes(busq)) || 
                (g.d_l && g.d_l.toLowerCase().includes(busq))
            );

            document.getElementById('lista').innerHTML = filtrados.map(g => `
                <div class="card-movil">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="font-size:18px; color:#d32f2f;">${g.num}</b>
                        <span class="badge ${g.estado}">${g.estado.toUpperCase()}</span>
                    </div>
                    <div style="margin:10px 0; font-size:14px; line-height:1.4;">
                        <b>Destinatario:</b> ${g.d_n}<br>
                        <b>Localidad:</b> ${g.d_l}<br>
                        <b>Direcci√≥n:</b> ${g.d_d}<br>
                        ${g.cr_activo === 'S' ? `<div style="margin-top:5px; padding:5px; background:yellow; color:red; font-weight:bold; border:2px solid red; text-align:center;">‚ö†Ô∏è COBRAR REEMBOLSO: $${g.cr_monto}</div>` : ''}
                    </div>
                    <div style="display:flex; gap:8px;">
                        <select onchange="actualizarEstado('${g.firebaseID}', this.value)" style="flex:1; padding:10px; border-radius:5px; border:1px solid #1a4a7a;">
                            <option value="recibido" ${g.estado==='recibido'?'selected':''}>Recibido</option>
                            <option value="deposito" ${g.estado==='deposito'?'selected':''}>En Dep√≥sito</option>
                            <option value="entregado" ${g.estado==='entregado'?'selected':''}>Entregado ‚úÖ</option>
                        </select>
                        <button onclick="verQR('${g.num}')" style="background:#1a4a7a; color:white; border:none; padding:10px; border-radius:5px; width:50px;">QR</button>
                    </div>
                </div>
            `).join('');
        };

        window.verQR = (num) => {
            document.getElementById('modalQR').style.display = 'flex';
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: num,
                width: 220,
                height: 220
            });
            document.getElementById('qrTitle').innerText = "GU√çA: " + num;
        };

        window.cerrarQR = () => { document.getElementById('modalQR').style.display = 'none'; };
        
        window.cerrarSesion = () => {
            sessionStorage.clear();
            window.location.href = "index.html";
        };
    </script>

    <style>
        :root { --azul: #102a43; --rojo: #d32f2f; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4f8; margin: 0; padding: 10px; padding-bottom: 50px; }
        
        /* HEADER CON LOGO */
        .header { 
            background: var(--azul); 
            color: white; 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .header img { height: 50px; width: auto; border-radius: 4px; }
        .header h2 { margin: 0; font-size: 18px; letter-spacing: 1px; }

        #search { 
            width: 100%; 
            box-sizing: border-box;
            padding: 15px; 
            border-radius: 30px; 
            border: 2px solid #1a4a7a; 
            margin-bottom: 20px; 
            font-size: 16px;
            outline: none;
        }

        .card-movil { 
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            border-left: 6px solid #1a4a7a; 
        }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .recibido { background: #bbdefb; color: #0d47a1; }
        .deposito { background: #fff9c4; color: #f57f17; }
        .entregado { background: #c8e6c9; color: #1b5e20; }
        
        #modalQR { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.9); display:none; 
            flex-direction:column; align-items:center; justify-content:center; z-index:1000; 
        }
        .modal-content { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 80%; }
        #qrcode { display: flex; justify-content: center; margin: 20px 0; }
        .btn-cerrar { background: var(--rojo); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: bold; width: 100%; }
        
        .footer-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #eee; padding: 5px; text-align: center; font-size: 10px; color: #666; }
    </style>
</head>
<body>

<div class="header">
    <img src="logo.png" onerror="this.src='https://via.placeholder.com/50/102a43/ffffff?text=M'">
    <div>
        <h2>MOULIN M√ìVIL</h2>
        <small style="opacity: 0.8;">Gesti√≥n de Choferes V7.0</small>
    </div>
</div>

<input type="text" id="search" placeholder="üîç Buscar gu√≠a o destino..." oninput="renderizarLista()">

<div id="lista"></div>

<div id="modalQR">
    <div class="modal-content">
        <h3 id="qrTitle" style="margin-top:0; color:#1a4a7a;"></h3>
        <div id="qrcode"></div>
        <button class="btn-cerrar" onclick="cerrarQR()">CERRAR VISOR</button>
    </div>
</div>

<div class="footer-nav" onclick="cerrarSesion()">
    Cerrar Sesi√≥n de Usuario
</div>

</body>
</html>
