<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Guías - Moulin Cloud</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #102a43;
            --secondary: #243b53;
            --accent: #334e68;
            --text: #f0f4f8;
            --success: #27ae60;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Header y Navegación */
        header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .logout-btn { background: #cf3d3d; border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .nav-tabs { background: var(--secondary); display: flex; padding: 0 20px; gap: 5px; }
        .tab { padding: 12px 25px; color: #9fb3c8; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; font-weight: 600; }
        .tab.active { color: white; border-bottom: 3px solid #62b1f6; background: rgba(255,255,255,0.1); }

        .content { flex: 1; padding: 25px; overflow-y: auto; }
        .panel { display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); max-width: 1000px; margin: auto; }
        .panel.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Formulario */
        .grid-form { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .full-width { grid-column: span 2; }
        .field-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: bold; color: var(--primary); font-size: 0.9rem; }
        input, select, textarea { padding: 12px; border: 1px solid #d9e2ec; border-radius: 6px; font-size: 1rem; transition: 0.3s; }
        input:focus { outline: none; border-color: #62b1f6; box-shadow: 0 0 0 3px rgba(98,177,246,0.2); }

        .btn-emitir { background: var(--success); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; width: 100%; transition: 0.3s; }
        .btn-emitir:hover { background: #219150; transform: translateY(-2px); }

        /* Historial */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e1e8ed; }
        th { background: #f8fafc; color: var(--primary); }
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; background: #e3f9e5; color: #1f7a33; }

        /* ESTILOS DE IMPRESIÓN MEJORADOS (PUNTO 3) */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { 
                position: absolute; 
                left: 0; top: 0; width: 100%; 
                margin: 0; padding: 20px;
                background: white !important;
            }
            @page { 
                size: A4; 
                margin: 10mm; /* Márgenes de seguridad */
            }
            .no-print { display: none !important; }
            
            /* Ajuste para que entre en una hoja */
            #printArea { transform: scale(0.95); transform-origin: top center; }
        }

        /* Diseño de la Guía Impresa */
        #printArea { padding: 40px; border: 2px solid #333; color: black; background: #fff; width: 800px; margin: auto; border-radius: 8px; }
        .print-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px; }
        .logo-box h1 { margin: 0; font-size: 2.5rem; letter-spacing: 2px; }
        .guia-nro { text-align: right; }
        .guia-nro h2 { margin: 0; color: #e63946; font-size: 1.8rem; }
        
        .print-section { margin-bottom: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .print-section h3 { 
            border-bottom: 1px solid #000; 
            margin-bottom: 10px; 
            font-size: 1.2rem; /* Letra de origen/destino más grande */
            text-transform: uppercase;
            background: #eee;
            padding: 5px;
        }
        .data-row { margin-bottom: 8px; font-size: 1.1rem; }
        .data-label { font-weight: bold; width: 120px; display: inline-block; }
        
        .table-items { width: 100%; border: 1px solid #000; margin: 20px 0; }
        .table-items th { background: #000; color: #fff; border: 1px solid #000; }
        .table-items td { border: 1px solid #000; padding: 12px; font-size: 1.1rem; }
        
        .print-footer { margin-top: 50px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center; }
        .signature-box { border-top: 1px solid #000; padding-top: 10px; margin-top: 40px; font-size: 0.9rem; }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <h2 style="margin:0">MOULIN <span style="font-weight:300; font-size: 1rem;">Logística Cloud</span></h2>
    </div>
    <div class="user-info">
        <span id="display-user" style="background: #243b53; padding: 5px 12px; border-radius: 4px;"></span>
        <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
    </div>
</header>

<div class="nav-tabs">
    <div class="tab active" onclick="showPanel('nueva-guia')">NUEVA GUÍA</div>
    <div class="tab" onclick="showPanel('historial'); updateTable();">HISTORIAL SUCURSAL</div>
    <div id="admin-tab" class="tab" style="display:none" onclick="showPanel('admin')">PANEL CONTROL</div>
</div>

<div class="content">
    <div id="nueva-guia" class="panel active">
        <div class="grid-form">
            <div class="field-group">
                <label>FECHA</label>
                <input type="date" id="fecha">
            </div>
            <div class="field-group">
                <label>TIPO DE SERVICIO</label>
                <select id="tipo-servicio">
                    <option value="Paquetería">Paquetería</option>
                    <option value="Carga General">Carga General</option>
                    <option value="Paletizado">Paletizado</option>
                    <option value="Urgente">Envío Urgente</option>
                </select>
            </div>

            <div class="field-group">
                <h3 style="margin-bottom:10px; color: #1a4a7a;">ORIGEN</h3>
                <label>REMITENTE</label>
                <input type="text" id="remitente" placeholder="Nombre o Razón Social">
                <label>LOCALIDAD ORIGEN</label>
                <input type="text" id="origen" placeholder="Ciudad">
            </div>

            <div class="field-group">
                <h3 style="margin-bottom:10px; color: #1a4a7a;">DESTINO</h3>
                <label>DESTINATARIO</label>
                <input type="text" id="destinatario" placeholder="Nombre de quien recibe">
                <label>LOCALIDAD DESTINO</label>
                <input type="text" id="destino" placeholder="Ciudad">
            </div>

            <div class="field-group full-width">
                <label>DESCRIPCIÓN DE CARGA / BULTOS</label>
                <textarea id="descripcion" rows="3" placeholder="Ej: 5 cajas de repuestos, 2 pallets..."></textarea>
            </div>

            <div class="field-group">
                <label>VALOR DECLARADO ($)</label>
                <input type="number" id="valor" placeholder="0.00">
            </div>
            <div class="field-group">
                <label>CONDICIÓN DE PAGO</label>
                <select id="pago">
                    <option value="Pagado en Origen">Pagado en Origen</option>
                    <option value="Pago en Destino">Pago en Destino</option>
                    <option value="Cuenta Corriente">Cuenta Corriente</option>
                </select>
            </div>
        </div>
        <button class="btn-emitir" onclick="confirmarEmision()">EMITIR E IMPRIMIR GUÍA</button>
    </div>

    <div id="historial" class="panel">
        <h3>MIS ENVÍOS RECIENTES</h3>
        <table id="tabla-guias">
            <thead>
                <tr>
                    <th>Nro Guía</th>
                    <th>Fecha</th>
                    <th>Destino</th>
                    <th>Remitente</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody id="body-guias"></tbody>
        </table>
    </div>

    <div id="admin" class="panel">
        <h3>REPORTE GLOBAL DE CARGA</h3>
        <button onclick="descargarCSV()" style="margin-bottom:20px; padding:10px; cursor:pointer">Exportar Excel (CSV)</button>
        <table id="tabla-admin">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Sucursal</th>
                    <th>Destino</th>
                    <th>Valor</th>
                    <th>Pago</th>
                </tr>
            </thead>
            <tbody id="body-admin"></tbody>
        </table>
    </div>
</div>

<div id="printArea" style="display:none">
    <div class="print-header">
        <div class="logo-box">
            <h1>MOULIN</h1>
            <p>Transporte & Logística</p>
        </div>
        <div class="guia-nro">
            <p>GUÍA DE TRANSPORTE</p>
            <h2 id="p-nro">---</h2>
            <p id="p-fecha"></p>
        </div>
    </div>

    <div class="print-section">
        <div>
            <h3>Origen / Remitente</h3>
            <div class="data-row"><span class="data-label">Nombre:</span> <span id="p-remitente"></span></div>
            <div class="data-row"><span class="data-label">Ciudad:</span> <span id="p-origen"></span></div>
        </div>
        <div>
            <h3>Destino / Destinatario</h3>
            <div class="data-row"><span class="data-label">Nombre:</span> <span id="p-destinatario"></span></div>
            <div class="data-row"><span class="data-label">Ciudad:</span> <span id="p-destino"></span></div>
        </div>
    </div>

    <table class="table-items">
        <thead>
            <tr>
                <th>DESCRIPCIÓN DE LA CARGA / BULTOS</th>
                <th>TIPO</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td id="p-desc" style="height: 100px; vertical-align: top;"></td>
                <td id="p-tipo" style="text-align: center;"></td>
            </tr>
        </tbody>
    </table>

    <div class="print-section">
        <div>
            <div class="data-row"><span class="data-label">VALOR DECL.:</span> $<span id="p-valor"></span></div>
            <div class="data-row"><span class="data-label">COND. PAGO:</span> <span id="p-pago"></span></div>
        </div>
        <div style="border: 1px solid #000; padding: 10px; text-align: center;">
            <strong>SELLO Y FIRMA</strong>
            <div style="height: 60px;"></div>
        </div>
    </div>

    <div class="print-footer">
        <div class="signature-box">Firma Remitente</div>
        <div class="signature-box">Firma Transporte</div>
        <div class="signature-box">Firma Destinatario</div>
    </div>
    
    <p style="font-size: 0.7rem; margin-top: 30px; text-align: center;">Documento generado por Sistema Moulin Cloud - Copia para Control</p>
</div>

<script>
    // SESIÓN Y SEGURIDAD
    const userSession = JSON.parse(sessionStorage.getItem('moulin_sesion'));
    if (!userSession) { window.location.href = "index.html"; }
    
    document.getElementById('display-user').innerText = `${userSession.nombre} (${userSession.prefijo})`;
    document.getElementById('fecha').valueAsDate = new Date();

    if (userSession.rol === 'admin') {
        document.getElementById('admin-tab').style.display = 'block';
    }

    function logout() {
        sessionStorage.clear();
        window.location.href = "index.html";
    }

    function showPanel(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // PUNTO 1: CONFIRMACIÓN ANTES DE EMITIR
    function confirmarEmision() {
        if (!document.getElementById('remitente').value || !document.getElementById('destinatario').value) {
            alert("Por favor completa los datos básicos (Remitente y Destinatario)");
            return;
        }

        const confirmar = confirm("¿Estás seguro de emitir esta guía? Una vez aceptado, se grabará en el sistema e imprimirá.");
        if (confirmar) {
            emitirGuia();
        }
    }

    function emitirGuia() {
        const id = userSession.prefijo + "-" + Math.floor(1000 + Math.random() * 9000);
        
        const guia = {
            id: id,
            sucursal: userSession.nombre,
            prefijo: userSession.prefijo,
            fecha: document.getElementById('fecha').value,
            remitente: document.getElementById('remitente').value,
            origen: document.getElementById('origen').value,
            destinatario: document.getElementById('destinatario').value,
            destino: document.getElementById('destino').value,
            descripcion: document.getElementById('descripcion').value,
            valor: document.getElementById('valor').value,
            pago: document.getElementById('pago').value,
            tipo: document.getElementById('tipo-servicio').value
        };

        // Guardar localmente (simulando base de datos en nube)
        let db = JSON.parse(localStorage.getItem('moulin_db')) || [];
        db.push(guia);
        localStorage.setItem('moulin_db', JSON.stringify(db));

        // Cargar datos en zona de impresión
        document.getElementById('p-nro').innerText = guia.id;
        document.getElementById('p-fecha').innerText = guia.fecha;
        document.getElementById('p-remitente').innerText = guia.remitente;
        document.getElementById('p-origen').innerText = guia.origen;
        document.getElementById('p-destinatario').innerText = guia.destinatario;
        document.getElementById('p-destino').innerText = guia.destino;
        document.getElementById('p-desc').innerText = guia.descripcion;
        document.getElementById('p-valor').innerText = guia.valor;
        document.getElementById('p-pago').innerText = guia.pago;
        document.getElementById('p-tipo').innerText = guia.tipo;

        // Imprimir
        document.getElementById('printArea').style.display = 'block';
        window.print();
        document.getElementById('printArea').style.display = 'none';
        
        alert("Guía " + id + " guardada y enviada a impresión.");
        location.reload(); 
    }

    // PUNTO 2: HISTORIAL FILTRADO POR USUARIO
    function updateTable() {
        const db = JSON.parse(localStorage.getItem('moulin_db')) || [];
        const body = document.getElementById('body-guias');
        body.innerHTML = '';

        // Filtrado inteligente
        const misGuias = db.filter(g => {
            if (userSession.rol === 'admin') return true; // El admin ve todo
            return g.prefijo === userSession.prefijo; // Sucursal solo ve lo suyo
        });

        misGuias.reverse().forEach(g => {
            body.innerHTML += `
                <tr>
                    <td><strong>${g.id}</strong></td>
                    <td>${g.fecha}</td>
                    <td>${g.destino}</td>
                    <td>${g.remitente}</td>
                    <td><span class="status-pill">En Tránsito</span></td>
                </tr>
            `;
        });

        // Cargar tabla Admin
        if(userSession.rol === 'admin') {
            const bodyAdmin = document.getElementById('body-admin');
            bodyAdmin.innerHTML = '';
            db.forEach(g => {
                bodyAdmin.innerHTML += `<tr><td>${g.id}</td><td>${g.sucursal}</td><td>${g.destino}</td><td>$${g.valor}</td><td>${g.pago}</td></tr>`;
            });
        }
    }

    function descargarCSV() {
        const db = JSON.parse(localStorage.getItem('moulin_db')) || [];
        let csv = "ID,Fecha,Sucursal,Remitente,Origen,Destinatario,Destino,Valor,Pago\n";
        db.forEach(g => {
            csv += `${g.id},${g.fecha},${g.sucursal},${g.remitente},${g.origen},${g.destinatario},${g.destino},${g.valor},${g.pago}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'reporte_moulin.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Carga inicial
    updateTable();
</script>
</body>
</html>
