<!DOCTYPE html>
<html lang="es">
<head>
ย ย <meta charset="UTF-8">
ย ย <title>SISTEMA MOULIN V70 - CONTROL TOTAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

ย ย <script type="module">
ย ย ย ย import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
ย ย ย ย import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

ย ย ย ย const firebaseConfig = {
ย ย ย ย ย ย apiKey: "AIzaSyCAsCocDQjimpjNo5l2oHTGO82XNTG7tzY",
ย ย ย ย ย ย authDomain: "transporte-moulin.firebaseapp.com",
ย ย ย ย ย ย databaseURL: "https://transporte-moulin-default-rtdb.firebaseio.com",
ย ย ย ย ย ย projectId: "transporte-moulin",
ย ย ย ย ย ย storageBucket: "transporte-moulin.firebasestorage.app",
ย ย ย ย ย ย messagingSenderId: "1022730425566",
ย ย ย ย ย ย appId: "1:1022730425566:web:1ec5b014b71d14ce579e4f"
ย ย ย ย };

ย ย ย ย const app = initializeApp(firebaseConfig);
ย ย ย ย const db = getDatabase(app);
ย ย ย ย const sesion = JSON.parse(sessionStorage.getItem('moulin_sesion'));
ย ย ย ย if (!sesion) { window.location.href = "index.html"; }

ย ย ย ย const PREFIJO = sesion.prefijo;
ย ย ย ย const NOMBRE = sesion.nombre;
ย ย ย ย const ROL = sesion.rol;

ย ย ย ย window.historialGlobal = [];
ย ย ย ย window.clientesGlobal = {};ย
ย ย ย ย window.filtroEstado = 'todos';
ย ย ย ย let proximoNumero = 1001;

ย ย ย ย onValue(ref(db, 'moulin/guias'), (snapshot) => {
ย ย ย ย ย ย const data = snapshot.val();
ย ย ย ย ย ย window.historialGlobal = data ? Object.entries(data).map(([id, val]) => ({...val, firebaseID: id})).reverse() : [];
ย ย ย ย ย ย if (window.historialGlobal.length > 0) {
ย ย ย ย ย ย ย ย const todos = window.historialGlobal.map(g => parseInt(g.num.split('-')[1]) || 0);
ย ย ย ย ย ย ย ย proximoNumero = Math.max(...todos) + 1;
ย ย ย ย ย ย }
ย ย ย ย ย ย document.getElementById('display_guia').innerText = `${PREFIJO}-${String(proximoNumero).padStart(5, '0')}`;
ย ย ย ย ย ย renderHistorial();
ย ย ย ย });

ย ย ย ย onValue(ref(db, 'moulin/clientes'), (snapshot) => {
ย ย ย ย ย ย window.clientesGlobal = snapshot.val() || {};
ย ย ย ย ย ย const datalist = document.getElementById('lista_clientes');
ย ย ย ย ย ย datalist.innerHTML = Object.keys(window.clientesGlobal).map(c => `<option value="${c}">`).join('');
ย ย ย ย });

ย ย ย ย window.completarCliente = function(tipo) {
ย ย ย ย ย ย const n = document.getElementById(`${tipo}_n`).value.trim();
ย ย ย ย ย ย const coincide = Object.keys(window.clientesGlobal).find(k => k.toLowerCase() === n.toLowerCase());
ย ย ย ย ย ย if (coincide) {
ย ย ย ย ย ย ย ย const c = window.clientesGlobal[coincide];
ย ย ย ย ย ย ย ย document.getElementById(`${tipo}_t`).value = c.t || "";
ย ย ย ย ย ย ย ย document.getElementById(`${tipo}_cbu`).value = c.cbu || "";
ย ย ย ย ย ย ย ย document.getElementById(`${tipo}_d`).value = c.d || "";
ย ย ย ย ย ย ย ย document.getElementById(`${tipo}_l`).value = c.l || "";
ย ย ย ย ย ย }
ย ย ย ย };

ย ย ย ย window.actualizarEstadoNube = (id, est) => {
ย ย ย ย ย ย update(ref(db, `moulin/guias/${id}`), { estado: est }).then(() => {
ย ย ย ย ย ย ย ย alert("Estado actualizado a " + est.toUpperCase());
ย ย ย ย ย ย });
ย ย ย ย };

ย ย ย ย window.cambiarFiltro = function(est, btn) {
ย ย ย ย ย ย window.filtroEstado = est;
ย ย ย ย ย ย document.querySelectorAll('.btn-filtro').forEach(b => b.classList.remove('active'));
ย ย ย ย ย ย btn.classList.add('active');
ย ย ย ย ย ย renderHistorial();
ย ย ย ย };

ย ย ย ย window.renderHistorial = function() {
ย ย ย ย ย ย const b = document.getElementById('busq').value.toLowerCase();
ย ย ย ย ย ย const filtrados = window.historialGlobal.filter(g => {
ย ย ย ย ย ย ย ย const coincideBusq = g.num.toLowerCase().includes(b) || (g.r_n && g.r_n.toLowerCase().includes(b)) || (g.d_n && g.d_n.toLowerCase().includes(b));
ย ย ย ย ย ย ย ย const coincideEst = window.filtroEstado === 'todos' || g.estado === window.filtroEstado;
ย ย ย ย ย ย ย ย return coincideBusq && coincideEst;
ย ย ย ย ย ย });
ย ย ย ย ย ย document.getElementById('contador').innerText = `${filtrados.length} guรญas`;
ย ย ย ย ย ย document.getElementById('listaHistorial').innerHTML = filtrados.map(g => `
ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย <td><b>${g.num}</b></td>
ย ย ย ย ย ย ย ย ย ย <td>${g.r_n} > ${g.d_n}</td>
ย ย ย ย ย ย ย ย ย ย <td>$${g.total}</td>
ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย <select onchange="actualizarEstadoNube('${g.firebaseID}', this.value)" style="font-size:11px;">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="recibido" ${g.estado==='recibido'?'selected':''}>Recibido</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="deposito" ${g.estado==='deposito'?'selected':''}>Depรณsito</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="entregado" ${g.estado==='entregado'?'selected':''}>Entregado</option>
ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย <td><button onclick="reimprimir('${g.num}')">๐จ๏ธ</button></td>
ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย `).join('');
ย ย ย ย };

ย ย ย ย window.confirmarYEmitir = function() {
ย ย ย ย ย ย if(!document.getElementById('r_n').value || !document.getElementById('d_n').value) return alert("Faltan datos.");
ย ย ย ย ย ย const d = calcularTotales();
            const idUnico = Date.now();
ย ย ย ย ย ย const guia = {
ย ย ย ย ย ย ย ย num: `${PREFIJO}-${String(proximoNumero).padStart(5, '0')}`,
ย ย ย ย ย ย ย ย fecha: new Date().toLocaleDateString(),
ย ย ย ย ย ย ย ย timestamp: idUnico,
ย ย ย ย ย ย ย ย r_n: document.getElementById('r_n').value, r_t: document.getElementById('r_t').value, r_cbu: document.getElementById('r_cbu').value, r_d: document.getElementById('r_d').value, r_l: document.getElementById('r_l').value,
ย ย ย ย ย ย ย ย d_n: document.getElementById('d_n').value, d_t: document.getElementById('d_t').value, d_cbu: document.getElementById('d_cbu').value, d_d: document.getElementById('d_d').value, d_l: document.getElementById('d_l').value,
ย ย ย ย ย ย ย ย flete: d.flete.toFixed(2), seg: d.seg.toFixed(2), total: d.total.toFixed(2), v_decl: d.v_decl.toFixed(2),
ย ย ย ย ย ย ย ย pago_en: document.getElementById('pago_en').value, condicion: document.getElementById('condicion').value,
ย ย ย ย ย ย ย ย estado: 'recibido', emisor: NOMBRE,
ย ย ย ย ย ย ย ย cr_monto: document.getElementById('cr_monto').value,
ย ย ย ย ย ย ย ย cr_activo: document.getElementById('cr_act').value,
ย ย ย ย ย ย ย ย items: Array.from(document.querySelectorAll('#cuerpoItems tr')).map(r => ({
ย ย ย ย ย ย ย ย ย ย c: r.querySelector('.i-cant').value, t: r.querySelector('.i-tipo').value, d: r.querySelector('.i-det').value, u: r.querySelector('.i-unit').value, vd: r.querySelector('.i-decl').value
ย ย ย ย ย ย ย ย }))
ย ย ย ย ย ย };
ย ย ย ย ย ย const updates = {};
ย ย ย ย ย ย updates[`moulin/guias/${idUnico}`] = guia;
ย ย ย ย ย ย updates[`moulin/clientes/${guia.r_n}`] = { t: guia.r_t, cbu: guia.r_cbu, d: guia.r_d, l: guia.r_l };
ย ย ย ย ย ย updates[`moulin/clientes/${guia.d_n}`] = { t: guia.d_t, cbu: guia.d_cbu, d: guia.d_d, l: guia.d_l };
ย ย ย ย ย ย update(ref(db), updates).then(() => { imprimir(guia); setTimeout(() => location.reload(), 500); });
ย ย ย ย };
ย ย </script>

ย ย <style>
ย ย ย ย :root { --azul: #1a4a7a; --oscuro: #102a43; --verde: #38a169; --rojo: #d32f2f; }
ย ย ย ย body { font-family: Arial, sans-serif; background: #f0f4f8; margin: 0; padding: 10px; padding-bottom: 90px; }
ย ย ย ย .hoja { background: white; max-width: 950px; margin: auto; padding: 15px; border-radius: 8px; }
ย ย ย ย .caja { background: #f9f9f9; padding: 10px; border: 1px solid #ddd; margin-bottom: 8px; border-radius: 5px; }
ย ย ย ย .grid-datos { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; }
ย ย ย ย input, select { width: 95%; padding: 6px; font-size: 12px; margin-bottom: 4px; border: 1px solid #ccc; border-radius: 3px; }
ย ย ย ย .tabla-items { width: 100%; border-collapse: collapse; font-size: 12px; }
ย ย ย ย .tabla-items th { background: var(--azul); color: white; padding: 6px; }
ย ย ย ย .btn-imprimir { background: var(--verde); color: white; border: none; padding: 12px 35px; border-radius: 25px; font-size: 18px; font-weight: bold; cursor: pointer; }
ย ย ย ย .btn-filtro { padding: 5px 10px; cursor: pointer; border: 1px solid #ccc; background: #eee; font-size: 11px; }
ย ย ย ย .active { background: var(--azul) !important; color: white !important; }

ย ย ย ย @media print {
ย ย ย ย ย ย @page { size: A4 portrait; margin: 0; }
ย ย ย ย ย ย .no-print { display: none !important; }
ย ย ย ย ย ย #seccion-impresion { display: block !important; padding: 0.5cm; }
ย ย ย ย ย ย .cupon { height: 13.8cm; border: 2px solid #000; margin-bottom: 0.5cm; padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; }
ย ย ย ย ย ย .tabla-print { width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 12px; }
ย ย ย ย ย ย .tabla-print th, .tabla-print td { border: 1px solid black; padding: 4px; }
ย ย ย ย ย ย .resaltado { background: #eee !important; -webkit-print-color-adjust: exact; font-weight: bold; padding: 2px; }
ย ย ย ย ย ย .cr-box { border: 4px solid black; background: #ffff00 !important; -webkit-print-color-adjust: exact; padding: 8px; text-align: center; font-weight: bold; font-size: 18px; margin: 5px 0; }
            /* 2. ESTILO PARA EL QR EN PAPEL */
            .qr-print { width: 75px; height: 75px; background: white; border: 1px solid #ccc; padding: 3px; display: flex; align-items: center; justify-content: center; }
ย ย ย ย }
ย ย ย ย #seccion-impresion { display: none; }
ย ย </style>
</head>
<body>

<datalist id="lista_clientes"></datalist>

<div class="hoja no-print">
ย ย <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 3px solid var(--azul); margin-bottom:10px;">
ย ย ย ย <h2 style="margin:0;">MOULIN CLOUD V70</h2>
ย ย ย ย <b id="display_guia" style="font-size:26px; color:var(--rojo)">...</b>
ย ย </div>

ย ย <div class="caja">
ย ย ย ย <b>REMITENTE</b>
ย ย ย ย <input type="text" id="r_n" list="lista_clientes" placeholder="Nombre" oninput="completarCliente('r')">
ย ย ย ย <div class="grid-datos">
ย ย ย ย ย ย <input type="text" id="r_t" placeholder="Tel">
ย ย ย ย ย ย <input type="text" id="r_d" placeholder="Direcciรณn">
ย ย ย ย ย ย <input type="text" id="r_l" placeholder="Localidad">
ย ย ย ย ย ย <input type="text" id="r_cbu" placeholder="CBU/Alias">
ย ย ย ย </div>
ย ย </div>
ย ย <div class="caja">
ย ย ย ย <b>DESTINATARIO</b>
ย ย ย ย <input type="text" id="d_n" list="lista_clientes" placeholder="Nombre" oninput="completarCliente('d')">
ย ย ย ย <div class="grid-datos">
ย ย ย ย ย ย <input type="text" id="d_t" placeholder="Tel">
ย ย ย ย ย ย <input type="text" id="d_d" placeholder="Direcciรณn">
ย ย ย ย ย ย <input type="text" id="d_l" placeholder="Localidad">
ย ย ย ย ย ย <input type="text" id="d_cbu" placeholder="CBU/Alias">
ย ย ย ย </div>
ย ย </div>

ย ย <div class="caja">
ย ย ย ย <table class="tabla-items">
ย ย ย ย ย ย <thead><tr><th>Cant</th><th>Tipo</th><th>Detalle</th><th>Unit $</th><th>Decl. $</th><th></th></tr></thead>
ย ย ย ย ย ย <tbody id="cuerpoItems"></tbody>
ย ย ย ย </table>
ย ย ย ย <button onclick="agregarFila()" style="margin:5px 0;">+ Item</button>
ย ย ย ย <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:5px; margin-top:5px;">
ย ย ย ย ย ย <select id="pago_en"><option>PAGO ORIGEN</option><option>PAGO DESTINO</option></select>
ย ย ย ย ย ย <select id="condicion"><option>CONTADO</option><option>CTA CTE</option></select>
ย ย ย ย ย ย <div style="display:flex; align-items:center; background:#eee; padding:2px;"><label style="font-size:10px;">Seg%</label><input type="number" id="p_seg" value="0.8"></div>
ย ย ย ย ย ย <select id="cr_act"><option value="N">CR: NO</option><option value="S">CR: SI</option></select>
ย ย ย ย ย ย <input type="number" id="cr_monto" placeholder="Monto CR $" value="0">
ย ย ย ย </div>
ย ย </div>

ย ย <div class="caja" style="max-height: 250px; overflow-y: auto;">
ย ย ย ย <div style="display:flex; gap:5px; margin-bottom:10px; align-items:center;">
ย ย ย ย ย ย <input type="text" id="busq" placeholder="๐ Buscar..." oninput="renderHistorial()" style="width:150px; margin:0;">
ย ย ย ย ย ย <button onclick="cambiarFiltro('todos', this)" class="btn-filtro active">Todos</button>
ย ย ย ย ย ย <button onclick="cambiarFiltro('recibido', this)" class="btn-filtro">Recibidos</button>
ย ย ย ย ย ย <button onclick="cambiarFiltro('deposito', this)" class="btn-filtro">Depรณsito</button>
ย ย ย ย ย ย <button onclick="cambiarFiltro('entregado', this)" class="btn-filtro">Entregados</button>
ย ย ย ย ย ย <span id="contador" style="font-size:12px; font-weight:bold; margin-left:auto;"></span>
ย ย ย ย </div>
ย ย ย ย <table class="tabla-items">
ย ย ย ย ย ย <thead><tr style="background:var(--oscuro); color:white;"><th>Nro</th><th>Trayecto</th><th>Total</th><th>Estado</th><th>๐จ๏ธ</th></tr></thead>
ย ย ย ย ย ย <tbody id="listaHistorial"></tbody>
ย ย ย ย </table>
ย ย </div>
</div>

<div style="position:fixed; bottom:0; left:0; width:100%; background:var(--oscuro); color:white; padding:15px; display:flex; justify-content:space-around; align-items:center; z-index:100;" class="no-print">
ย ย <div id="total_txt" style="font-size:24px; font-weight:bold; color:#48bb78;">TOTAL: $ 0.00</div>
ย ย <button class="btn-imprimir" onclick="confirmarYEmitir()">GRABAR E IMPRIMIR A4</button>
</div>

<div id="seccion-impresion"></div>

<script>
ย ย function agregarFila() {
ย ย ย ย const tr = document.createElement('tr');
ย ย ย ย tr.innerHTML = `<td><input type="number" class="i-cant" value="1" oninput="calcularTotales()"></td><td><select class="i-tipo"><option>Bulto</option><option>Pallet</option><option>Sobre</option></select></td><td><input type="text" class="i-det"></td><td><input type="number" class="i-unit" value="18000" oninput="calcularTotales()"></td><td><input type="number" class="i-decl" value="0" oninput="calcularTotales()"></td><td><button onclick="this.parentElement.parentElement.remove(); calcularTotales();">โ</button></td>`;
ย ย ย ย document.getElementById('cuerpoItems').appendChild(tr);
ย ย ย ย calcularTotales();
ย ย }
ย ย function calcularTotales() {
ย ย ย ย let f = 0, vd = 0;ย
ย ย ย ย document.querySelectorAll('#cuerpoItems tr').forEach(r => {ย
ย ย ย ย ย ย f += (parseFloat(r.querySelector('.i-cant').value)||0)*(parseFloat(r.querySelector('.i-unit').value)||0);ย
ย ย ย ย ย ย vd += (parseFloat(r.querySelector('.i-decl').value)||0);
ย ย ย ย });
ย ย ย ย let seg = vd * (parseFloat(document.getElementById('p_seg').value)/100 || 0);
ย ย ย ย let t = f + seg;
ย ย ย ย document.getElementById('total_txt').innerText = `TOTAL: $ ${t.toLocaleString('es-AR')}`;
ย ย ย ย return {flete: f, seg: seg, total: t, v_decl: vd};
ย ย }

ย ย function imprimir(g) {
ย ย ย ย let itemsHTML = g.items.map(i => `<tr><td align="center">${i.c}</td><td>${i.t}</td><td>${i.d}</td><td align="right">$${i.u}</td><td align="right">$${i.vd}</td></tr>`).join('');
ย ย ย ย let html = "";
ย ย ย ย ['Original', 'Duplicado'].forEach((titulo, idx) => {
ย ย ย ย ย ย html += `
ย ย ย ย ย ย <div class="cupon">
ย ย ย ย ย ย ย ย <div style="display:flex; justify-content:space-between; align-items:center;">
ย ย ย ย ย ย ย ย ย ย <div style="display:flex; align-items:center; gap:12px; width:33%">
ย ย ย ย ย ย ย ย ย ย ย ย <img src="logo.png" style="height:55px" onerror="this.src='https://via.placeholder.com/60x55?text=L'">
ย ย ย ย ย ย ย ย ย ย ย ย <div><b style="font-size:18px;">TRANSPORTE MOULIN</b><br><small>Logรญstica y Distribuciรณn</small></div>
ย ย ย ย ย ย ย ย ย ย </div>
                    
                    <div id="qr_${idx}" class="qr-print"></div>

ย ย ย ย ย ย ย ย ย ย <div style="text-align:right; width:33%"><b style="font-size:16px;">${titulo}</b><br><b style="font-size:26px; color:red;">GUรA: ${g.num}</b><br><b>Fecha: ${g.fecha}</b></div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ${g.cr_activo === 'S' ? `<div class="cr-box">โ๏ธ COBRAR CONTRA REEMBOLSO: $ ${g.cr_monto}</div>` : ''}

ย ย ย ย ย ย ย ย <div style="display:grid; grid-template-columns:1fr 1fr; border:2px solid #000; margin:10px 0; padding:12px; font-size:13px;">
ย ย ย ย ย ย ย ย ย ย <div style="border-right:1px solid #000; padding-right:10px;"><b>REMITENTE:</b> ${g.r_n}<br><b>Dir:</b> ${g.r_d} | <b>Tel:</b> ${g.r_t}<br><b>Loc:</b> <span class="resaltado">${g.r_l}</span><br><b>CBU:</b> ${g.r_cbu}</div>
ย ย ย ย ย ย ย ย ย ย <div style="padding-left:10px;"><b>DESTINATARIO:</b> ${g.d_n}<br><b>Dir:</b> ${g.d_d} | <b>Tel:</b> ${g.d_t}<br><b>Loc:</b> <span class="resaltado">${g.d_l}</span><br><b>CBU:</b> ${g.d_cbu}</div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <table class="tabla-print">
ย ย ย ย ย ย ย ย ย ย <thead><tr style="background:#eee;"><th>Cant</th><th>Tipo</th><th>Detalle</th><th>Unitario</th><th>Valor Decl.</th></tr></thead>
ย ย ย ย ย ย ย ย ย ย <tbody>${itemsHTML}</tbody>
ย ย ย ย ย ย ย ย </table>

ย ย ย ย ย ย ย ย <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:13px;">
ย ย ย ย ย ย ย ย ย ย <div><b>PAGO:</b> ${g.pago_en} | <b>CONDICIรN:</b> ${g.condicion}<br><b>V. DECLARADO: $${g.v_decl}</b></div>
ย ย ย ย ย ย ย ย ย ย <div style="text-align:right;">Flete: $${g.flete} | Seg: $${g.seg}<br><b style="font-size:22px;">TOTAL A PAGAR: $${g.total}</b></div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div style="margin-top:auto; padding-top:25px; text-align:right;"><div style="display:inline-block; border-top:2px solid #000; width:350px; text-align:center; padding-top:5px;"><b>Recibรญ Conforme Firma y Aclaraciรณn</b></div></div>
ย ย ย ย ย ย </div>`;
ย ย ย ย });
ย ย ย ย document.getElementById('seccion-impresion').innerHTML = html;

        // 4. GENERACIรN DE LOS QRS DESPUรS DE RENDERIZAR
        setTimeout(() => {
            new QRCode(document.getElementById("qr_0"), { text: g.num, width: 75, height: 75 });
            new QRCode(document.getElementById("qr_1"), { text: g.num, width: 75, height: 75 });
            window.print();
        }, 300);
ย ย }

ย ย window.reimprimir = (n) => imprimir(window.historialGlobal.find(x => x.num === n));
ย ย window.onload = () => { agregarFila(); };
</script>
</body>
</html>
