<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Guías - Moulin Cloud</title>
    <style>
        :root {
            --primary: #102a43;
            --secondary: #243b53;
            --accent: #334e68;
            --text: #f0f4f8;
            --success: #27ae60;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .logout-btn { background: #cf3d3d; border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .nav-tabs { background: var(--secondary); display: flex; padding: 0 20px; gap: 5px; }
        .tab { padding: 12px 25px; color: #9fb3c8; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; font-weight: 600; }
        .tab.active { color: white; border-bottom: 3px solid #62b1f6; background: rgba(255,255,255,0.1); }
        .content { flex: 1; padding: 25px; overflow-y: auto; }
        .panel { display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); max-width: 1000px; margin: auto; }
        .panel.active { display: block; }
        .grid-form { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .full-width { grid-column: span 2; }
        .field-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: bold; color: var(--primary); font-size: 0.9rem; }
        input, select, textarea { padding: 12px; border: 1px solid #d9e2ec; border-radius: 6px; font-size: 1rem; }
        .btn-emitir { background: var(--success); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; width: 100%; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e1e8ed; }
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; background: #e3f9e5; color: #1f7a33; }

        /* MEJORA 3: IMPRESIÓN FORZADA EN UNA HOJA Y LETRA GRANDE */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { 
                position: absolute; left: 0; top: 0; width: 100%; 
                transform: scale(0.85); transform-origin: top center; 
            }
            @page { size: A4; margin: 5mm; }
            .print-section h3 { font-size: 1.6rem !important; background: #eee !important; padding: 5px !important; border: 1px solid #000 !important; }
        }

        #printArea { padding: 40px; border: 2px solid #333; color: black; background: #fff; width: 800px; margin: auto; }
        .print-header { display: flex; justify-content: space-between; border-bottom: 3px solid #000; padding-bottom: 15px; }
        .print-section { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .data-label { font-weight: bold; width: 120px; display: inline-block; }
        .table-items { width: 100%; border: 1px solid #000; margin: 20px 0; border-collapse: collapse; }
        .table-items th, .table-items td { border: 1px solid #000; padding: 10px; }
    </style>
</head>
<body>

<header>
    <div class="logo"><h2>MOULIN <span style="font-weight:300; font-size: 1rem;">Logística Cloud</span></h2></div>
    <div class="user-info"><span id="display-user"></span><button class="logout-btn" onclick="logout()">Cerrar Sesión</button></div>
</header>

<div class="nav-tabs">
    <div class="tab active" onclick="showPanel('nueva-guia')">NUEVA GUÍA</div>
    <div class="tab" onclick="showPanel('historial'); updateTable();">HISTORIAL SUCURSAL</div>
    <div id="admin-tab" class="tab" style="display:none" onclick="showPanel('admin')">PANEL CONTROL</div>
</div>

<div class="content">
    <div id="nueva-guia" class="panel active">
        <div class="grid-form">
            <div class="field-group"><label>FECHA</label><input type="date" id="fecha"></div>
            <div class="field-group"><label>TIPO DE SERVICIO</label>
                <select id="tipo-servicio">
                    <option value="Paquetería">Paquetería</option>
                    <option value="Carga General">Carga General</option>
                    <option value="Paletizado">Paletizado</option>
                </select>
            </div>
            <div class="field-group">
                <h3 style="color: #1a4a7a;">ORIGEN</h3>
                <label>REMITENTE</label><input type="text" id="remitente">
                <label>LOCALIDAD ORIGEN</label><input type="text" id="origen">
            </div>
            <div class="field-group">
                <h3 style="color: #1a4a7a;">DESTINO</h3>
                <label>DESTINATARIO</label><input type="text" id="destinatario">
                <label>LOCALIDAD DESTINO</label><input type="text" id="destino">
            </div>
            <div class="field-group full-width"><label>DESCRIPCIÓN</label><textarea id="descripcion" rows="3"></textarea></div>
            <div class="field-group"><label>VALOR ($)</label><input type="number" id="valor"></div>
            <div class="field-group"><label>PAGO</label>
                <select id="pago">
                    <option value="Pagado en Origen">Pagado en Origen</option>
                    <option value="Pago en Destino">Pago en Destino</option>
                </select>
            </div>
        </div>
        <button class="btn-emitir" onclick="confirmarEmision()">EMITIR E IMPRIMIR GUÍA</button>
    </div>

    <div id="historial" class="panel">
        <h3>MIS ENVÍOS RECIENTES</h3>
        <table>
            <thead><tr><th>Nro Guía</th><th>Fecha</th><th>Destino</th><th>Remitente</th><th>Estado</th></tr></thead>
            <tbody id="body-guias"></tbody>
        </table>
    </div>

    <div id="admin" class="panel">
        <h3>REPORTE GLOBAL</h3>
        <button onclick="descargarCSV()">Exportar CSV</button>
        <table>
            <thead><tr><th>ID</th><th>Sucursal</th><th>Destino</th><th>Valor</th></tr></thead>
            <tbody id="body-admin"></tbody>
        </table>
    </div>
</div>

<div id="printArea" style="display:none">
    <div class="print-header">
        <div><h1>MOULIN</h1><p>Transporte & Logística</p></div>
        <div style="text-align:right"><p>GUÍA</p><h2 id="p-nro"></h2><p id="p-fecha"></p></div>
    </div>
    <div class="print-section">
        <div><h3>Origen</h3><p id="p-remitente"></p><p id="p-origen"></p></div>
        <div><h3>Destino</h3><p id="p-destinatario"></p><p id="p-destino"></p></div>
    </div>
    <table class="table-items">
        <thead><tr><th>DESCRIPCIÓN</th><th>TIPO</th></tr></thead>
        <tbody><tr><td id="p-desc" style="height:80px"></td><td id="p-tipo"></td></tr></tbody>
    </table>
    <p>VALOR: $<span id="p-valor"></span> | PAGO: <span id="p-pago"></span></p>
</div>

<script>
    const userSession = JSON.parse(sessionStorage.getItem('moulin_sesion'));
    if (!userSession) { window.location.href = "index.html"; }
    document.getElementById('display-user').innerText = userSession.nombre;
    document.getElementById('fecha').valueAsDate = new Date();
    if (userSession.rol === 'admin') document.getElementById('admin-tab').style.display = 'block';

    function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
    function showPanel(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(event) event.currentTarget.classList.add('active');
    }

    // MEJORA 1: CONFIRMACIÓN
    function confirmarEmision() {
        if(confirm("¿Desea grabar e imprimir esta guía?")) emitirGuia();
    }

    function emitirGuia() {
        const id = userSession.prefijo + "-" + Math.floor(1000 + Math.random() * 9000);
        const guia = {
            id: id, sucursal: userSession.nombre, prefijo: userSession.prefijo,
            fecha: document.getElementById('fecha').value, remitente: document.getElementById('remitente').value,
            origen: document.getElementById('origen').value, destinatario: document.getElementById('destinatario').value,
            destino: document.getElementById('destino').value, descripcion: document.getElementById('descripcion').value,
            valor: document.getElementById('valor').value, pago: document.getElementById('pago').value,
            tipo: document.getElementById('tipo-servicio').value
        };
        let db = JSON.parse(localStorage.getItem('moulin_db')) || [];
        db.push(guia);
        localStorage.setItem('moulin_db', JSON.stringify(db));

        document.getElementById('p-nro').innerText = id;
        document.getElementById('p-fecha').innerText = guia.fecha;
        document.getElementById('p-remitente').innerText = guia.remitente;
        document.getElementById('p-origen').innerText = guia.origen;
        document.getElementById('p-destinatario').innerText = guia.destinatario;
        document.getElementById('p-destino').innerText = guia.destino;
        document.getElementById('p-desc').innerText = guia.descripcion;
        document.getElementById('p-valor').innerText = guia.valor;
        document.getElementById('p-pago').innerText = guia.pago;
        document.getElementById('p-tipo').innerText = guia.tipo;

        document.getElementById('printArea').style.display = 'block';
        window.print();
        document.getElementById('printArea').style.display = 'none';
        location.reload();
    }

    // MEJORA 2: PRIVACIDAD SUCURSAL
    function updateTable() {
        const db = JSON.parse(localStorage.getItem('moulin_db')) || [];
        const body = document.getElementById('body-guias');
        body.innerHTML = '';
        
        db.filter(g => userSession.rol === 'admin' || g.prefijo === userSession.prefijo)
          .reverse().forEach(g => {
            body.innerHTML += `<tr><td>${g.id}</td><td>${g.fecha}</td><td>${g.destino}</td><td>${g.remitente}</td><td><span class="status-pill">En Tránsito</span></td></tr>`;
        });

        if(userSession.rol === 'admin') {
            const bAdmin = document.getElementById('body-admin');
            bAdmin.innerHTML = '';
            db.forEach(g => { bAdmin.innerHTML += `<tr><td>${g.id}</td><td>${g.sucursal}</td><td>${g.destino}</td><td>$${g.valor}</td></tr>`; });
        }
    }

    function descargarCSV() {
        const db = JSON.parse(localStorage.getItem('moulin_db')) || [];
        let csv = "ID,Fecha,Sucursal,Remitente,Destino,Valor\n";
        db.forEach(g => { csv += `${g.id},${g.fecha},${g.sucursal},${g.remitente},${g.destino},${g.valor}\n`; });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'reporte.csv'; a.click();
    }
    updateTable();
</script>
</body>
</html>
