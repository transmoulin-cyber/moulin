<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA MOULIN V7.8 - CONTROL TOTAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCAsCocDQjimpjNo5l2oHTGO82XNTG7tzY",
            authDomain: "transporte-moulin.firebaseapp.com",
            databaseURL: "https://transporte-moulin-default-rtdb.firebaseio.com",
            projectId: "transporte-moulin",
            storageBucket: "transporte-moulin.firebasestorage.app",
            messagingSenderId: "1022730425566",
            appId: "1:1022730425566:web:1ec5b014b71d14ce579e4f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const sesion = JSON.parse(sessionStorage.getItem('moulin_sesion'));
        if (!sesion) { window.location.href = "index.html"; }

        const PREFIJO_BASE = sesion.prefijo;
        const PREFIJO = (["TODO","ADM","REC"].includes(PREFIJO_BASE)) ? "RECON" : PREFIJO_BASE;
        
        window.historialGlobal = [];
        window.filtroEstadoActual = 'todos';
        let proximoNumero = 1001;

        // Escucha de gu√≠as
        onValue(ref(db, 'moulin/guias'), (snapshot) => {
            const data = snapshot.val();
            window.historialGlobal = data ? Object.entries(data).map(([id, val]) => ({...val, firebaseID: id})).reverse() : [];
            const misGuias = window.historialGlobal.filter(g => g.num.startsWith(PREFIJO));
            if (misGuias.length > 0) {
                const max = Math.max(...misGuias.map(g => parseInt(g.num.split('-')[1]) || 0));
                proximoNumero = max + 1;
            }
            document.getElementById('display_guia').innerText = `${PREFIJO}-${String(proximoNumero).padStart(5, '0')}`;
            renderHistorial();
        });

        window.actualizarEstadoNube = (id, est) => update(ref(db, `moulin/guias/${id}`), { estado: est });

        window.cambiarFiltroEstado = (est, btn) => {
            window.filtroEstadoActual = est;
            document.querySelectorAll('.btn-f').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderHistorial();
        };

        window.renderHistorial = () => {
            const busq = document.getElementById('busq').value.toLowerCase();
            const fDesde = document.getElementById('f_desde').value;
            const fHasta = document.getElementById('f_hasta').value;

            const filtrados = window.historialGlobal.filter(g => {
                // 1. Filtro Sucursal (Admin ve todo)
                let suc = (PREFIJO_BASE === "ADM" || PREFIJO_BASE === "TODO") || 
                          (PREFIJO === "RECON" ? (g.num.startsWith("RECON") || g.num.startsWith("REC")) : g.num.startsWith(PREFIJO));
                
                // 2. Filtro Estado
                let est = (window.filtroEstadoActual === 'todos' || g.estado === window.filtroEstadoActual);

                // 3. Filtro Fechas
                let fec = true;
                if(fDesde || fHasta){
                    const p = g.fecha.split('/');
                    const fGuia = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                    if (fDesde && fGuia < fDesde) fec = false;
                    if (fHasta && fGuia > fHasta) fec = false;
                }

                // 4. B√∫squeda
                const b = g.num.toLowerCase().includes(busq) || g.r_n.toLowerCase().includes(busq) || g.d_n.toLowerCase().includes(busq);
                
                return suc && est && fec && b;
            });

            window.datosParaExcel = filtrados;
            document.getElementById('listaHistorial').innerHTML = filtrados.map(g => `
                <tr>
                    <td><b>${g.num}</b></td>
                    <td>${g.fecha}</td>
                    <td>${g.r_n} > ${g.d_n}</td>
                    <td>$${g.total}</td>
                    <td>
                        <select onchange="actualizarEstadoNube('${g.firebaseID}', this.value)" style="font-size:11px; background:${g.estado==='entregado'?'#d4edda':'white'}">
                            <option value="recibido" ${g.estado==='recibido'?'selected':''}>Recibido</option>
                            <option value="deposito" ${g.estado==='deposito'?'selected':''}>Dep√≥sito</option>
                            <option value="entregado" ${g.estado==='entregado'?'selected':''}>Entregado</option>
                        </select>
                    </td>
                    <td><button onclick="reimprimir('${g.num}')">üñ®Ô∏è</button></td>
                </tr>
            `).join('');
        };

        window.descargarExcel = () => {
            const data = window.datosParaExcel.map(g => ({ Guia: g.num, Fecha: g.fecha, Remitente: g.r_n, Destinatario: g.d_n, Total: g.total, Estado: g.estado }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Guias");
            XLSX.writeFile(wb, `Moulin_Filtro_${new Date().toLocaleDateString()}.xlsx`);
        };
    </script>

    <style>
        :root { --azul: #1a4a7a; --verde: #38a169; }
        body { font-family: sans-serif; background: #f0f4f8; margin: 0; padding: 10px; padding-bottom: 120px; }
        .hoja { background: white; max-width: 1000px; margin: auto; padding: 20px; border-radius: 8px; }
        .caja { background: #f8fafc; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 10px; }
        .btn-f { padding: 8px 15px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px; }
        .active { background: var(--azul) !important; color: white; }
        .btn-excel { background: #1d6f42; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        input, select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; width: 95%; }
        .tabla-items { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        .tabla-items th { background: var(--azul); color: white; padding: 8px; }
        .tabla-items td { border-bottom: 1px solid #eee; padding: 8px; }
        @media print { .no-print { display: none !important; } #seccion-impresion { display: block !important; } .cupon { height: 13.8cm; border: 1px solid #000; padding: 15px; margin-bottom: 10px; page-break-after: always; } }
        #seccion-impresion { display: none; }
    </style>
</head>
<body>

<div class="hoja no-print">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 4px solid var(--azul); padding-bottom:10px; margin-bottom:15px;">
        <h2 style="margin:0;">SISTEMA MOULIN V7.8</h2>
        <b id="display_guia" style="font-size:30px; color:red;">---</b>
    </div>

    <div class="caja" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
        <div style="display:flex; gap:5px;">
            <button class="btn-f active" onclick="cambiarFiltroEstado('todos', this)">Todos</button>
            <button class="btn-f" onclick="cambiarFiltroEstado('recibido', this)">Recibidos</button>
            <button class="btn-f" onclick="cambiarFiltroEstado('deposito', this)">En Dep√≥sito</button>
            <button class="btn-f" onclick="cambiarFiltroEstado('entregado', this)">Entregados</button>
        </div>
        <div style="display:flex; gap:5px; align-items:center;">
            <input type="date" id="f_desde" onchange="renderHistorial()" style="width:130px;">
            <span>al</span>
            <input type="date" id="f_hasta" onchange="renderHistorial()" style="width:130px;">
            <button class="btn-excel" onclick="descargarExcel()">üìä Excel</button>
        </div>
    </div>

    <div class="caja">
        <input type="text" id="busq" placeholder="üîç Buscar gu√≠a o cliente..." oninput="renderHistorial()" style="width:100%; padding:10px; margin-bottom:10px; font-size:16px; border:2px solid var(--azul);">
        <table class="tabla-items">
            <thead><tr><th>Gu√≠a</th><th>Fecha</th><th>Ruta</th><th>Total</th><th>Estado</th><th>üñ®Ô∏è</th></tr></thead>
            <tbody id="listaHistorial"></tbody>
        </table>
    </div>

    </div>

<div id="seccion-impresion"></div>
</body>
</html>
