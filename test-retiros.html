<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>LABORATORIO - MOULIN RETIROS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCAsCocDQjimpjNo5l2oHTGO82XNTG7tzY",
            authDomain: "transporte-moulin.firebaseapp.com",
            databaseURL: "https://transporte-moulin-default-rtdb.firebaseio.com",
            projectId: "transporte-moulin",
            storageBucket: "transporte-moulin.firebasestorage.app",
            messagingSenderId: "1022730425566",
            appId: "1:1022730425566:web:1ec5b014b71d14ce579e4f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const sesion = JSON.parse(sessionStorage.getItem('moulin_sesion'));
        if (!sesion) { window.location.href = "index.html"; }

        const PREFIJO_BASE = sesion.prefijo;
        const PREFIJO = (["TODO","ADM","REC"].includes(PREFIJO_BASE)) ? "RECON" : PREFIJO_BASE;
        const NOMBRE_OP = sesion.nombre;

        window.historialGlobal = [];
        window.clientesGlobal = {}; 
        window.retirosGlobal = [];
        let proximoNumero = 1001;

        // --- L√ìGICA DE RETIROS ---
        onValue(ref(db, 'moulin/retiros'), (snapshot) => {
            const data = snapshot.val();
            window.retirosGlobal = data ? Object.entries(data).map(([id, val]) => ({...val, id})) : [];
            renderRetiros();
        });

        window.solicitarRetiro = () => {
            const r = {
                cliente: document.getElementById('ret_n').value,
                direccion: document.getElementById('ret_d').value,
                localidad: document.getElementById('ret_l').value,
                tel: document.getElementById('ret_t').value,
                detalle: document.getElementById('ret_obs').value,
                fecha: new Date().toLocaleDateString(),
                estado: 'pendiente',
                sucursal: PREFIJO
            };
            if(!r.cliente || !r.direccion) return alert("Cargar cliente y direcci√≥n");
            push(ref(db, 'moulin/retiros'), r);
            alert("Retiro solicitado correctamente");
            document.querySelectorAll('.input-ret').forEach(i => i.value = "");
        };

        window.renderRetiros = () => {
            const lista = document.getElementById('listaRetiros');
            lista.innerHTML = window.retirosGlobal.filter(x => x.estado === 'pendiente').map(r => `
                <div style="background:white; border-left:5px solid orange; padding:10px; margin-bottom:10px; border-radius:4px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b>${r.cliente}</b> - ${r.direccion} (${r.localidad})<br>
                        <small>Obs: ${r.detalle} | Fecha: ${r.fecha}</small>
                    </div>
                    <button onclick="convertirAGuia('${r.id}')" style="background:#1a4a7a; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer;">üöö Convertir a Gu√≠a</button>
                </div>
            `).join('');
        };

        window.convertirAGuia = (id) => {
            const r = window.retirosGlobal.find(x => x.id === id);
            // Llenamos el formulario de gu√≠a
            document.getElementById('r_n').value = r.cliente;
            document.getElementById('r_d').value = r.direccion;
            document.getElementById('r_l').value = r.localidad;
            document.getElementById('r_t').value = r.tel;
            // Cambiamos a la pesta√±a de gu√≠a
            cambiarTab('tab-guia');
            // Marcamos como "En proceso" o lo borramos despu√©s si quer√©s
            update(ref(db, `moulin/retiros/${id}`), { estado: 'en_guia' });
        };

        // --- L√ìGICA DE GUIAS (TUYA ORIGINAL) ---
        onValue(ref(db, 'moulin/guias'), (snapshot) => {
            const data = snapshot.val();
            window.historialGlobal = data ? Object.entries(data).map(([id, val]) => ({...val, firebaseID: id})).reverse() : [];
            const misGuias = window.historialGlobal.filter(g => g.num.startsWith(PREFIJO));
            if (misGuias.length > 0) {
                const max = Math.max(...misGuias.map(g => parseInt(g.num.split('-')[1]) || 0));
                proximoNumero = max + 1;
            }
            document.getElementById('display_guia').innerText = `${PREFIJO}-${String(proximoNumero).padStart(5, '0')}`;
            renderHistorial();
        });

        // (Mantengo el resto de tus funciones: completarCliente, calcularTotales, etc.)
        // [Aqu√≠ va toda la l√≥gica que ya ten√≠as en la V8.7]
    </script>

    <style>
        :root { --azul: #1a4a7a; --oscuro: #102a43; --verde: #38a169; }
        body { font-family: sans-serif; background: #f0f4f8; margin: 0; padding-bottom: 120px; }
        .nav-tabs { background: var(--oscuro); padding: 10px; display: flex; gap: 10px; justify-content: center; position: sticky; top: 0; z-index: 2000; }
        .nav-tabs button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #243b55; color: white; }
        .nav-tabs button.active { background: #3182ce; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        /* Tus estilos originales */
        .hoja { background: white; max-width: 950px; margin: auto; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .caja { background: #f8fafc; padding: 12px; border: 1px solid #e2e8f0; margin-bottom: 10px; border-radius: 6px; }
        input, select { padding: 7px; border: 1px solid #cbd5e1; border-radius: 4px; width: 95%; margin-bottom: 4px; font-size: 13px; }
        .btn-imprimir { background: var(--verde); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 18px; cursor: pointer; font-weight: bold; }
        /* [Resto de tus estilos...] */
    </style>
</head>
<body>

<div class="nav-tabs no-print">
    <button id="btn-guia" class="active" onclick="cambiarTab('tab-guia')">1. EMITIR GU√çA</button>
    <button id="btn-retiros" onclick="cambiarTab('tab-retiros')">2. SOLICITUD DE RETIROS</button>
</div>

<div id="tab-guia" class="tab-content active">
    <div class="hoja no-print">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 3px solid var(--azul); margin-bottom:15px;">
            <h2>TRANSPORTE MOULIN - EMISI√ìN</h2>
            <b id="display_guia" style="font-size:28px; color:red;">---</b>
        </div>
        </div>
</div>

<div id="tab-retiros" class="tab-content">
    <div class="hoja">
        <h2>SOLICITAR RETIRO</h2>
        <div class="caja" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="text" id="ret_n" class="input-ret" placeholder="Nombre/Cliente">
            <input type="text" id="ret_d" class="input-ret" placeholder="Direcci√≥n de Retiro">
            <input type="text" id="ret_l" class="input-ret" placeholder="Localidad">
            <input type="text" id="ret_t" class="input-ret" placeholder="Tel√©fono">
            <input type="text" id="ret_obs" class="input-ret" style="grid-column: span 2;" placeholder="¬øQu√© hay que retirar? (Ej: 2 pallets, 1 caja grande)">
            <button onclick="solicitarRetiro()" style="grid-column: span 2; padding:15px; background:var(--verde); color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">CARGAR PEDIDO DE RETIRO</button>
        </div>
        
        <h3 style="margin-top:30px; color:var(--azul);">RETIROS PENDIENTES</h3>
        <div id="listaRetiros">
            </div>
    </div>
</div>

<script>
    function cambiarTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'tab-guia') document.getElementById('btn-guia').classList.add('active');
        if(id === 'tab-retiros') document.getElementById('btn-retiros').classList.add('active');
    }

    // [Pegar aqu√≠ tus funciones de agregarFila, imprimir, calcularTotales, etc.]
</script>

</body>
</html>